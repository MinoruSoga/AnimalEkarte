# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

## æ¦‚è¦

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯**ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

| æ–¹å¼ | ç”¨é€” | ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|------|------|-----------|
| SQL ãƒ•ã‚¡ã‚¤ãƒ« | åˆæœŸã‚¹ã‚­ãƒ¼ãƒä½œæˆ | Dockeråˆå›èµ·å‹•æ™‚ |
| GORM AutoMigrate | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«åŒæœŸ | ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ |

---

## 1. SQL ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆDockerè‡ªå‹•å®Ÿè¡Œï¼‰

### ä»•çµ„ã¿

PostgreSQL ã‚³ãƒ³ãƒ†ãƒŠã¯ `/docker-entrypoint-initdb.d/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã® SQL ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**åˆå›èµ·å‹•æ™‚ã®ã¿**è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ã€‚

```yaml
# docker-compose.yml
db:
  image: postgres:18-alpine
  volumes:
    - ./backend/migrations:/docker-entrypoint-initdb.d
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

```
backend/migrations/
â””â”€â”€ 001_init.sql    # åˆæœŸã‚¹ã‚­ãƒ¼ãƒï¼ˆowners, pets, medical_recordsï¼‰
```

### å‘½åè¦å‰‡

```
{ç•ªå·}_{èª¬æ˜}.sql

ä¾‹:
001_init.sql
002_add_reservations.sql
003_add_hospitalizations.sql
```

### å®Ÿè¡Œé †åº

- ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ï¼ˆæ•°å­—ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§åˆ¶å¾¡ï¼‰
- **åˆå›èµ·å‹•æ™‚ã®ã¿å®Ÿè¡Œ**ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰

---

## 2. GORM AutoMigrateï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ï¼‰

### ä»•çµ„ã¿

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã« GORM ãŒãƒ¢ãƒ‡ãƒ«å®šç¾©ã¨ DB ã‚¹ã‚­ãƒ¼ãƒã‚’æ¯”è¼ƒã—ã€å·®åˆ†ã‚’è‡ªå‹•é©ç”¨ã—ã¾ã™ã€‚

```go
// backend/cmd/api/main.go
if err := db.AutoMigrate(&model.Pet{}); err != nil {
    logger.Error("failed to migrate database", slog.String("error", err.Error()))
    os.Exit(1)
}
```

### ç¾åœ¨ã®å¯¾è±¡ãƒ¢ãƒ‡ãƒ«

| ãƒ¢ãƒ‡ãƒ« | ãƒ†ãƒ¼ãƒ–ãƒ« | çŠ¶æ…‹ |
|--------|---------|------|
| Pet | pets | âœ… AutoMigrateå¯¾è±¡ |
| Owner | owners | ğŸ“‹ SQL ã®ã¿ |
| MedicalRecord | medical_records | ğŸ“‹ SQL ã®ã¿ |

### AutoMigrate ã®å‹•ä½œ

- ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ â†’ ä½œæˆ
- ã‚«ãƒ©ãƒ ãŒä¸è¶³ â†’ è¿½åŠ 
- ã‚«ãƒ©ãƒ ã®å‰Šé™¤ â†’ **ã—ãªã„**ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â†’ è¿½åŠ ã®ã¿

---

## 3. å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```
make up / make build
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. PostgreSQL ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•         â”‚
â”‚     â””â”€ åˆå›: migrations/*.sql å®Ÿè¡Œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿ              â”‚
â”‚     â””â”€ pg_isready ã§ DB æº–å‚™ç¢ºèª    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Backend ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•            â”‚
â”‚     â””â”€ GORM AutoMigrate å®Ÿè¡Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. API ã‚µãƒ¼ãƒãƒ¼é–‹å§‹                â”‚
â”‚     â””â”€ :8080 ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æ“ä½œã‚³ãƒãƒ³ãƒ‰

### åŸºæœ¬æ“ä½œ

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|---------|------|
| `make up` | ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ï¼ˆåˆå›ã¯è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ |
| `make build` | å†ãƒ“ãƒ«ãƒ‰ï¼†èµ·å‹• |
| `make down` | ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ |
| `make db` | PostgreSQL ã«æ¥ç¶šï¼ˆpsqlï¼‰ |

### ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|---------|------|
| `make reset` | **å®Œå…¨ãƒªã‚»ãƒƒãƒˆ**ï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤â†’å†ä½œæˆï¼‰ |
| `make clean` | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼†å†ãƒ“ãƒ«ãƒ‰ |

### çŠ¶æ…‹ç¢ºèª

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ­ã‚°ç¢ºèª
make logs

# DB æ¥ç¶šã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
make db
\dt              # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
\d pets          # pets ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
```

---

## 5. æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ æ‰‹é †

### æ–¹æ³• A: SQL ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 

```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch backend/migrations/002_add_reservations.sql

# 2. SQL è¨˜è¿°
cat << 'EOF' > backend/migrations/002_add_reservations.sql
-- äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
CREATE TABLE IF NOT EXISTS reservations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    pet_id UUID REFERENCES pets(id) ON DELETE CASCADE,
    -- ... ä»–ã®ã‚«ãƒ©ãƒ 
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
EOF

# 3. DB ãƒªã‚»ãƒƒãƒˆï¼ˆåˆå›å®Ÿè¡Œã®ã¿SQLé©ç”¨ã•ã‚Œã‚‹ãŸã‚ï¼‰
make reset
```

### æ–¹æ³• B: GORM ãƒ¢ãƒ‡ãƒ«è¿½åŠ 

```go
// 1. ãƒ¢ãƒ‡ãƒ«å®šç¾© (backend/internal/model/reservation.go)
type Reservation struct {
    ID        uuid.UUID `gorm:"type:uuid;default:uuid_generate_v4();primaryKey"`
    PetID     uuid.UUID `gorm:"type:uuid;not null"`
    // ... ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    CreatedAt time.Time
}

// 2. AutoMigrate ã«è¿½åŠ  (backend/cmd/api/main.go)
if err := db.AutoMigrate(&model.Pet{}, &model.Reservation{}); err != nil {
    // ...
}
```

---

## 6. ç’°å¢ƒå¤‰æ•°

```bash
# .env
DB_USER=ekarte_user
DB_PASSWORD=<secure_password>
DB_NAME=ekarte_db
```

```go
// æ¥ç¶šå…ˆï¼ˆDockerå†…éƒ¨ï¼‰
DB_HOST=db
DB_PORT=5432
```

---

## 7. å®Ÿè£…çŠ¶æ³

### ç¾åœ¨å®Ÿè£…æ¸ˆã¿ï¼ˆSQL + GORMï¼‰

| ãƒ†ãƒ¼ãƒ–ãƒ« | SQL | GORM Model | Repository | Handler |
|---------|:---:|:----------:|:----------:|:-------:|
| owners | âœ… | âŒ | âŒ | âŒ |
| pets | âœ… | âœ… | âœ… | âœ… |
| medical_records | âœ… | âŒ | âŒ | âŒ |

### å°†æ¥å®Ÿè£…äºˆå®šï¼ˆERD.md å‚ç…§ï¼‰

- reservations
- hospitalizations
- accountings
- vaccinations
- trimmings
- examinations
- ãã®ä»– 14 ãƒ†ãƒ¼ãƒ–ãƒ«

---

## 8. æ³¨æ„äº‹é …

### âš ï¸ åˆå›èµ·å‹•æ™‚ã®ã¿ SQL å®Ÿè¡Œ

PostgreSQL Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä»•æ§˜ã«ã‚ˆã‚Šã€SQL ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯**ãƒ‡ãƒ¼ã‚¿ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒç©ºã®æ™‚ã®ã¿**å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```bash
# æ–°ã—ã„ SQL ã‚’é©ç”¨ã™ã‚‹ã«ã¯
make reset  # ãƒ‡ãƒ¼ã‚¿å‰Šé™¤â†’å†ä½œæˆ
```

### âš ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã¯**è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã›ã‚“**ã€‚

```bash
# æ‰‹å‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¿…è¦ãªå ´åˆï¼‰
make db
DROP TABLE IF EXISTS table_name CASCADE;
```

### âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã®æ¨å¥¨

æœ¬ç•ªç’°å¢ƒã§ã¯å°‚ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã®å°å…¥ã‚’æ¨å¥¨ã—ã¾ã™ï¼š

| ãƒ„ãƒ¼ãƒ« | ç‰¹å¾´ |
|--------|------|
| [golang-migrate](https://github.com/golang-migrate/migrate) | SQL ãƒ™ãƒ¼ã‚¹ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ |
| [goose](https://github.com/pressly/goose) | SQL/Go ä¸¡å¯¾å¿œã€ã‚·ãƒ³ãƒ—ãƒ« |
| [atlas](https://atlasgo.io/) | å®£è¨€çš„ã‚¹ã‚­ãƒ¼ãƒç®¡ç† |

---

## 9. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œãªã„

```bash
# åŸå› : ãƒ‡ãƒ¼ã‚¿ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹
# è§£æ±º: å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
make reset
```

### ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ã‚¨ãƒ©ãƒ¼

```bash
# åŸå› : ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœªå®Ÿè¡Œ or å¤±æ•—
# ç¢ºèª
make logs | grep -i migration

# æ‰‹å‹•å®Ÿè¡Œ
make db
\i /docker-entrypoint-initdb.d/001_init.sql
```

### GORM AutoMigrate ã‚¨ãƒ©ãƒ¼

```bash
# ç¢ºèª
make logs-api | grep -i migrate

# ãƒ¢ãƒ‡ãƒ«å®šç¾©ã¨DBæ§‹é€ ã®ä¸æ•´åˆã‚’ç¢ºèª
make db
\d pets
```

---

## å‚ç…§

- [ERDï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼‰](./ERD.md)
- [Backend README](../backend/README.md)
- [Docker Compose è¨­å®š](../docker-compose.yml)
